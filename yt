#!/bin/bash

# ==========================================
# YT - Advanced YouTube Downloader
# Auto venv + auto install yt-dlp
# ==========================================

BASE_DIR="$HOME/Videos"
VENV_DIR="$BASE_DIR/venv"
ARCHIVE_FILE="$BASE_DIR/.yt_archive"

DOWNLOAD_DIR="$BASE_DIR"
FORMAT="bv+ba/b"
MERGE="mp4"

AUDIO_ONLY=false
PLAYLIST=true
QUALITY=""
SUBS=false
THUMB=false
CLEAN_ARCHIVE=false
SHOW_ARCHIVE=false
FORCE=false
QUIET=false
UPDATE=false

# ==========================================
# Setup Environment
# ==========================================

setup_environment() {

    mkdir -p "$BASE_DIR"
    cd "$BASE_DIR" || exit 1

    # Create venv if not exists
    if [ ! -d "$VENV_DIR" ]; then
        echo "Criando ambiente virtual..."
        python3 -m venv "$VENV_DIR"
    fi

    # Activate
    source "$VENV_DIR/bin/activate"

    # Install yt-dlp if not installed
    if ! python -c "import yt_dlp" &>/dev/null; then
        echo "Instalando yt-dlp no venv..."
        pip install --upgrade pip
        pip install yt-dlp
    fi
}

# ==========================================
# Help
# ==========================================

show_help() {
cat << EOF
YT - Advanced YouTube Downloader

Uso:
  yt [opções] <URL1> [URL2] ...

Download:
  -a, --audio                Apenas áudio (mp3)
  -q, --quality <valor>      Qualidade máxima (720, 1080, 2160...)
  -n, --no-playlist          Ignorar playlist
  -s, --subs                 Baixar e embutir legendas
  -t, --thumbnail            Baixar e embutir thumbnail
  -d, --dir <caminho>        Diretório de download

Archive:
  -c, --clean                Limpar histórico
  -l, --list                 Mostrar histórico
  -y, --yes                  Confirmar automaticamente

Sistema:
  -u, --update               Atualizar yt-dlp
  -Q, --quiet                Modo silencioso
  -h, --help                 Mostrar ajuda

EOF
exit 0
}

# ==========================================
# Argument parsing
# ==========================================

while [[ "$1" == -* ]]; do
    case "$1" in
        -a|--audio) AUDIO_ONLY=true; shift ;;
        -q|--quality) QUALITY="$2"; shift 2 ;;
        -n|--no-playlist) PLAYLIST=false; shift ;;
        -s|--subs) SUBS=true; shift ;;
        -t|--thumbnail) THUMB=true; shift ;;
        -d|--dir) DOWNLOAD_DIR="$2"; shift 2 ;;
        -c|--clean) CLEAN_ARCHIVE=true; shift ;;
        -l|--list) SHOW_ARCHIVE=true; shift ;;
        -y|--yes) FORCE=true; shift ;;
        -Q|--quiet) QUIET=true; shift ;;
        -u|--update) UPDATE=true; shift ;;
        -h|--help) show_help ;;
        *) echo "Opção inválida: $1"; exit 1 ;;
    esac
done

# ==========================================
# Prepare environment
# ==========================================

setup_environment

# ==========================================
# System actions
# ==========================================

if [ "$UPDATE" = true ]; then
    yt-dlp -U
    exit 0
fi

if [ "$SHOW_ARCHIVE" = true ]; then
    [ -f "$ARCHIVE_FILE" ] && cat "$ARCHIVE_FILE" || echo "Arquivo não existe."
    exit 0
fi

if [ "$CLEAN_ARCHIVE" = true ]; then
    if [ -f "$ARCHIVE_FILE" ]; then
        if [ "$FORCE" = true ]; then
            rm "$ARCHIVE_FILE"
            echo "Archive removido."
        else
            read -p "Apagar archive? (s/N): " CONFIRM
            [[ "$CONFIRM" =~ ^[sS]$ ]] && rm "$ARCHIVE_FILE" && echo "Removido." || echo "Cancelado."
        fi
    else
        echo "Arquivo não existe."
    fi
    exit 0
fi

if [ "$#" -lt 1 ]; then
    show_help
fi

# ==========================================
# Build yt-dlp options
# ==========================================

YTDLP_OPTS=(
    --download-archive "$ARCHIVE_FILE"
    -o "$DOWNLOAD_DIR/%(title)s.%(ext)s"
)

[ "$PLAYLIST" = false ] && YTDLP_OPTS+=(--no-playlist)
[ "$SUBS" = true ] && YTDLP_OPTS+=(--write-subs --sub-lang all --embed-subs)
[ "$THUMB" = true ] && YTDLP_OPTS+=(--write-thumbnail --embed-thumbnail)
[ "$QUIET" = true ] && YTDLP_OPTS+=(--quiet)

if [ "$AUDIO_ONLY" = true ]; then
    YTDLP_OPTS+=(
        -f bestaudio
        --extract-audio
        --audio-format mp3
        --audio-quality 0
    )
else
    if [ -n "$QUALITY" ]; then
        YTDLP_OPTS+=(-f "bestvideo[height<=${QUALITY}]+bestaudio/best")
    else
        YTDLP_OPTS+=(-f "$FORMAT" --merge-output-format "$MERGE")
    fi
fi

# ==========================================
# Execute
# ==========================================

yt-dlp "${YTDLP_OPTS[@]}" "$@"